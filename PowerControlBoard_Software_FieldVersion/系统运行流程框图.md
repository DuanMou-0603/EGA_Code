# 超级电容控制板系统运行流程框图

## 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           超级电容控制板系统运行流程                                │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   系统启动   │───▶│  硬件初始化  │───▶│  主循环运行  │───▶│  中断处理   │
│  (main.c)   │    │ (UserTask)  │    │ (UserTask)  │    │(PowerMgr)  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                  │                  │                  │
       ▼                  ▼                  ▼                  ▼
  HAL库初始化        外设配置完成        低频任务调度        高频控制环路
  时钟配置          系统状态设置        通信处理            功率控制
  systemStart()     systemInited=true   保护检测            ADC采样
```

## 详细运行流程

### 1. 系统启动阶段 (main.c)

```
┌─────────────────┐
│   main() 函数    │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│  HAL_Init()     │  ← HAL库初始化
└─────────────────┘
         │
         ▼
┌─────────────────┐
│SystemClock_Config│  ← 系统时钟配置
└─────────────────┘
         │
         ▼
┌─────────────────┐
│  MX_GPIO_Init() │  ← GPIO初始化
└─────────────────┘
         │
         ▼
┌─────────────────┐
│  MX_DMA_Init()  │  ← DMA初始化
└─────────────────┘
         │
         ▼
┌─────────────────┐
│ MX_ADC_Init()等 │  ← 外设初始化
└─────────────────┘
         │
         ▼
┌─────────────────┐
│ systemStart()   │  ← 调用用户任务
└─────────────────┘
```

### 2. 硬件初始化阶段 (UserTask.cpp - init())

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              init() 函数执行流程                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  保护系统初始化    │───▶│   ADC系统初始化  │───▶│  通信系统初始化  │
│configAWDG()     │    │initAnalog()     │    │CANcomm::init()  │
│                 │    │initADC()        │    │Buzzer::init()   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                      │                      │
         ▼                      ▼                      ▼
    模拟看门狗配置          运放/DAC/比较器配置      CAN通信配置
    硬件故障保护          ADC校准和DMA启动        蜂鸣器初始化

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  定时器系统配置  │───▶│  WPT系统初始化   │───▶│  HRTIM系统启动  │
│TIM6注册回调     │    │ASKcomm::init()  │    │startTimer()    │
│TIM6/TIM16启动   │    │(条件编译)       │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                      │                      │
         ▼                      ▼                      ▼
    4kHz系统时钟基准        ASK通信初始化          高频PWM控制启动
    低频任务调度器          无线充电通信          功率开关控制

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   硬件验证      │───▶│   启动提示      │───▶│   系统就绪      │
│checkHardwareUID │    │Buzzer::play()   │    │systemInited    │
│                │    │HAL_Delay(400)   │    │= true          │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                      │                      │
         ▼                      ▼                      ▼
    UID检查验证            蜂鸣器提示音播放        系统初始化完成标志
    硬件身份确认            延时稳定等待            进入正常运行模式
```

### 3. 主循环运行阶段 (UserTask.cpp - loop() + tickCallback())

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              主循环系统架构                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐                    ┌─────────────────┐
│   主循环线程     │                    │   TIM6中断线程   │
│   loop()       │                    │  tickCallback() │
│   (无限循环)    │                    │   (4kHz频率)    │
└─────────────────┘                    └─────────────────┘
         │                                      │
         ▼                                      ▼
┌─────────────────┐                    ┌─────────────────┐
│  HAL_Delay(1)   │                    │  低频任务调度    │
│  简单延时等待    │                    │  (1kHz轮询)     │
└─────────────────┘                    └─────────────────┘
                                               │
                                               ▼
                                    ┌─────────────────┐
                                    │  高频任务执行    │
                                    │  (4kHz直接)     │
                                    └─────────────────┘
```

### 4. TIM6中断任务调度详细流程 (4kHz)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          TIM6 tickCallback() 执行流程                            │
└─────────────────────────────────────────────────────────────────────────────────┘

每4kHz执行一次 ──┐
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            低频任务轮询 (1kHz)                                   │
│  lfLoopIndex状态机：0→1→2→3→0 循环，每个状态1kHz执行                              │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   状态 0 (1kHz)  │───▶│   状态 1 (1kHz)  │───▶│   状态 2 (1kHz)  │───▶│   状态 3 (1kHz)  │
│                  │    │                │     │                │    │                │
│• vTick++         │    │• CAN数据发送    │     │• 电容容量估算   │       │• 低电压检测     │
│• 蜂鸣器更新       │     │• 数据超时检查   │     │• ADC低频更新    │      │• 蜂鸣器序列     │
│• 错误处理LF       │     │• 按钮状态更新   │    │                │      │• WPT状态管理    │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
         │                      │                      │                      │
         ▼                      ▼                      ▼                      ▼
    系统时钟维护            通信和用户接口          系统监测和诊断          保护和WPT控制
    基础错误处理            外部数据交换            电容状态评估            无线充电管理

┌─────────────────────────────────────────────────────────────────────────────────┐
│                            高频任务执行 (4kHz)                                   │
│  每次TIM6中断都执行，不依赖状态机                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  电源开关控制    │───▶│   WPT功率管理    │───▶│   ASK通信处理   │
│powerOnOffControl│    │  (条件编译)      │    │  askLoop()     │
│                │    │                │    │  (条件编译)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                      │                      │
         ▼                      ▼                      ▼
    输出使能/禁用控制        无线充电状态监控        ASK调制通信
    欠压保护和恢复          功率需求管理            数据包传输
    软启动时序控制          安全保护检测            通信协议处理
```

### 5. HRTIM高频中断处理 (17kHz)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      HRTIM1_Master_IRQHandler (17kHz)                          │
│                        高频功率控制环路                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

每17kHz执行 ──┐
             │
             ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   ADC数据更新    │───▶│  功率级模式管理  │───▶│   输出状态检查   │
│updateADCmf()    │    │modeStateMachine │    │outputABEnabled │
│                │    │                │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                      │                      │
         ▼                      ▼                      ▼
    实时电流/电压采样        DCDC模式自动切换        输出使能状态判断
    功率计算和滤波          BUCK/BOOST模式选择      控制分支选择

                    ┌─────────────────────────────────┐
                    │           输出已使能             │
                    └─────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   短路保护检测   │───▶│  功率控制环路    │───▶│  电感电流设置    │───▶│   效率计算      │
│checkShortCircuit│    │updateMFLoop()   │    │setInductorCurr  │    │checkEfficiency  │
│                │    │                │    │                │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
         │                      │                      │                      │
         ▼                      ▼                      ▼                      ▼
    A/B侧短路检测           裁判系统功率PID控制      DAC锯齿波电流控制       双向功率效率监测
    电压电流阈值判断        电容充放电管理          正负电流双向控制        系统性能评估

┌─────────────────┐
│  电容电流估算    │
│updateCurrentfor │
│Estimation       │
└─────────────────┘
         │
         ▼
    电流最值记录
    容量估算数据收集

                    ┌─────────────────────────────────┐
                    │           输出未使能             │
                    └─────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  目标电流设置    │───▶│   增量清零      │───▶│   PID状态重置   │
│iLTarget = -2.0f │    │deltaIL = 0.0f   │    │iRPID.resetError│
│                │    │                │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                      │                      │
         ▼                      ▼                      ▼
    预充电流设置            控制增量归零            PID历史状态清除
    系统待机准备            避免积分饱和            准备重新启动
```

### 6. 通信系统处理流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              通信系统架构                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐                    ┌─────────────────┐
│   CAN通信系统    │                    │   ASK通信系统    │
│  (Communication) │                    │  (WPT专用)      │
└─────────────────┘                    └─────────────────┘
         │                                      │
         ▼                                      ▼
┌─────────────────┐                    ┌─────────────────┐
│  FDCAN3中断接收  │                    │   GPIO调制发送   │
│  (实时触发)     │                    │   (4kHz轮询)    │
└─────────────────┘                    └─────────────────┘
         │                                      │
         ▼                                      ▼
┌─────────────────┐                    ┌─────────────────┐
│  数据解析处理    │                    │   数据包编码     │
│rxDataHandler()  │                    │  packData()     │
└─────────────────┘                    └─────────────────┘
         │                                      │
         ▼                                      ▼
┌─────────────────┐                    ┌─────────────────┐
│  功率控制更新    │                    │   状态机发送     │
│updateRefereePwr │                    │  askLoop()      │
└─────────────────┘                    └─────────────────┘
         │                                      │
         ▼                                      ▼
    裁判系统功率管理                        无线充电通信协议
    能量缓冲区控制                          功率需求传输
    系统状态反馈                            设备状态同步

┌─────────────────┐
│   定时数据发送   │
│  sendSCData()   │
│   (1kHz)       │
└─────────────────┘
         │
         ▼
    系统状态上报
    功率数据反馈
    错误状态通知
```

### 7. 保护系统运行机制

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              保护系统架构                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   硬件保护层     │───▶│   软件保护层     │───▶│   系统保护层     │
│  (HRTIM Fault)  │    │  (中断检测)     │    │  (状态管理)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                      │                      │
         ▼                      ▼                      ▼
    硬件故障立即响应          软件算法保护检测        系统级错误管理
    过压/过流硬件切断        短路/效率监测          错误等级分类
    HRTIM自动保护           阈值计数保护            自动/手动恢复

┌─────────────────────────────────────────────────────────────────────────────────┐
│                            保护检测时序                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

硬件保护 (实时) ──┐
                 │
                 ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  HRTIM Fault    │───▶│  立即禁用输出    │───▶│  设置错误代码    │
│  中断触发       │    │disableOutputAB  │    │ERROR_OVP/OCP   │
└─────────────────┘    └─────────────────┘    └─────────────────┘

软件保护 (17kHz) ──┐
                  │
                  ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  短路检测       │───▶│  计数器累积     │───▶│  阈值触发保护    │
│checkShortCircuit│    │shortCircuitCnt  │    │禁用输出+错误码  │
└─────────────────┘    └─────────────────┘    └─────────────────┘

系统保护 (1kHz) ──┐
                 │
                 ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  错误状态管理    │───▶│  自动恢复机制    │───▶│  手动清除接口    │
│errorHandlerLF   │    │autoClearError   │    │manualClearError │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 系统运行关键参数

### 时序参数
- **HRTIM主频率**: 136kHz (功率开关频率)
- **HRTIM中断频率**: 17kHz (136kHz/8)
- **TIM6中断频率**: 4kHz (系统调度基准)
- **低频任务频率**: 1kHz (轮询调度)
- **CAN通信频率**: 1kHz (数据发送)
- **ASK通信频率**: 2kHz (无线充电通信)

### 控制环路
- **电流环**: 17kHz (HRTIM中断)
- **功率环**: 17kHz (裁判系统PID)
- **电压环**: 1kHz (电容管理)
- **保护环**: 多层次 (硬件实时 + 软件17kHz + 系统1kHz)

### 数据流向
```
裁判系统 ──CAN──▶ 功率控制 ──HRTIM──▶ 电流控制 ──DAC──▶ 功率级
    ▲                ▲                ▲              │
    │                │                │              ▼
状态反馈 ◀──────── 保护系统 ◀──────── ADC采样 ◀────── 电流/电压检测
    │                │                │
    ▼                ▼                ▼
底盘通信          错误处理          超级电容管理
```

## 总结

该超级电容控制板系统采用多层次、多频率的实时控制架构：

1. **硬件层**: HRTIM提供高频PWM控制和硬件保护
2. **实时层**: 17kHz中断处理功率控制环路
3. **系统层**: 4kHz调度器管理系统任务
4. **应用层**: 1kHz轮询处理通信和监测
5. **保护层**: 多级保护机制确保系统安全

系统通过精确的时序控制和多重保护机制，实现了高效、安全的超级电容充放电管理，满足机器人竞赛的高功率、快响应需求。